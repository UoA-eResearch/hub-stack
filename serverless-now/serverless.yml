service: serverless-now

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'} # Deploy with sls deploy --stage STAGE (default dev)
  region: ap-southeast-2
  endpointType: regional
  role: arn:aws:iam::416527880812:role/lambda_basic_execution_with_read_only_access_to_SSM
  stackTags:
    ResearchHub: ${self:service}
    BusinessService: Faculty of Science
    Department: Centre for eResearch
    ProjectCode: N/A
    WikiLink: N/A
    Application: ${self:service}
    CostCentre: N/A
  environment:
    # Environment variables available to all functions in this service
    ENV: ${self:provider.stage}
    LEVEL: INFO
    EXAMPLE_KEY: ${ssm:/${self:provider.stage}/research-hub/example-key~true}
    SN_API_KEY_R: ${ssm:/${self:provider.stage}/research-hub/SN_API_KEY_R~true}
    SN_DEV_API_KEY_RW: ${ssm:/${self:provider.stage}/research-hub/SN_DEV_API_KEY_RW~true}
    COGNITO_DOMAIN: "uoapool-sandbox.auth.ap-southeast-2.amazoncognito.com"
  iamRoleStatements:
    - Effect: Allow
      Action:
        - ssm:GetParameter
        - ssm:GetParameters
      Resource:
        - "arn:aws:ssm:${self:provider.region}:416527880812:parameter/${self:provider.stage}/research-hub/*"
    - Effect: Allow
      Action:
        - kms:Decrypt
      Resource:
        - "arn:aws:kms:ap-southeast-2:416527880812:key/3cf7aeb4-ad8c-4505-a8e3-7d2a556e188d"
  alb:
    authorizers:
      cognito-authorizer-uoapool:
        type: 'cognito'
        userPoolArn: 'arn:aws:cognito-idp:ap-southeast-2:416527880812:userpool/ap-southeast-2_pgErjyL4O'
        userPoolClientId: 'lrju6v80vse4bbaesjvnr2ff0' # required
        userPoolDomain: 'uoapool-sandbox' # required
        scope: 'openid profile https://my-domain.auckland.ac.nz/angular-test' 

package:
  exclude:
    - .git/**
    - .vscode/*
    - events/*
    - node_modules/**
    - '!node_modules/@uoa/**'
    - '!node_modules/uuid/**'

functions:
  serverless-now:
    handler: handler.main
    events:
      - http:
          path: serverless-now
          method: get
          cors: true
          authorizer:
            name: serverless-now-auth
            type: cognito_user_pools
            arn: arn:aws:cognito-idp:ap-southeast-2:416527880812:userpool/ap-southeast-2_pgErjyL4O
            identitySource: method.request.header.Authorization
            scopes: 
              - openid
              - profile
              - https://test-domain.auckland.ac.nz/lambda-hello-world
      - http:
          path: serverless-now
          method: post
          cors: true
          authorizer:
            name: serverless-now-auth
            type: cognito_user_pools
            arn: arn:aws:cognito-idp:ap-southeast-2:416527880812:userpool/ap-southeast-2_pgErjyL4O
            identitySource: method.request.header.Authorization
            scopes: 
              - openid
              - profile
              - https://test-domain.auckland.ac.nz/lambda-hello-world
              
plugins:
  - serverless-offline
  - serverless-mocha-plugin